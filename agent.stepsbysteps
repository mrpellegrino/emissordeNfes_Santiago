# PASSO A PASSO DETALHADO - SISTEMA DE EMISSﾃグ DE NOTAS FISCAIS DE SERVIﾃ⑯

## 搭 IMPORTANTE: ATUALIZAﾃﾃグ DO JSON DE REFERﾃ劾CIA DA API
Em cada implementaﾃｧﾃ｣o de mﾃｳdulo ou endpoint, ﾃｩ OBRIGATﾃ迭IO atualizar o arquivo `postman-collection.json` com:
- Novos endpoints criados
- Exemplos de requisiﾃｧﾃｵes e respostas
- Headers de autenticaﾃｧﾃ｣o necessﾃ｡rios
- Validaﾃｧﾃｵes e casos de erro
- Documentaﾃｧﾃ｣o no arquivo `POSTMAN_GUIDE.md`

## FASE 1: CONFIGURAﾃﾃグ INICIAL DO PROJETO

### 1.1 Configuraﾃｧﾃ｣o do Backend (NestJS)
- [ ] Navegar para pasta backend
- [ ] Verificar se todas as dependﾃｪncias estﾃ｣o instaladas
- [ ] Instalar dependﾃｪncias adicionais necessﾃ｡rias:
  ```bash
  npm install @nestjs/typeorm typeorm pg
  npm install @nestjs/jwt @nestjs/passport passport passport-jwt
  npm install bcryptjs multer xlsx
  npm install class-validator class-transformer
  npm install @nestjs/config
  npm install axios # Para integraﾃｧﾃ｣o com Bling API
  ```
- [ ] Configurar variﾃ｡veis de ambiente (.env):
  ```
  DATABASE_HOST=localhost
  DATABASE_PORT=5432
  DATABASE_USERNAME=postgres
  DATABASE_PASSWORD=senha
  DATABASE_NAME=nfse_sistema
  JWT_SECRET=seu_jwt_secret_aqui
  BLING_API_TOKEN=seu_token_bling_aqui
  BLING_API_URL=https://api.bling.com.br/Api/v3
  ```

### 1.2 Configuraﾃｧﾃ｣o do Frontend (React + Vite)
- [ ] Navegar para pasta frontend
- [ ] Verificar se todas as dependﾃｪncias estﾃ｣o instaladas
- [ ] Instalar dependﾃｪncias adicionais:
  ```bash
  npm install react-router-dom
  npm install axios
  npm install @types/react-router-dom
  npm install lucide-react # Para ﾃｭcones
  npm install react-hot-toast # Para notificaﾃｧﾃｵes
  npm install react-hook-form
  npm install xlsx # Para manipulaﾃｧﾃ｣o de planilhas
  ```

### 1.3 Configuraﾃｧﾃ｣o do Banco de Dados
- [ ] Instalar PostgreSQL localmente ou configurar container Docker
- [ ] Criar database 'nfse_sistema'
- [ ] Configurar conexﾃ｣o no data-source.ts do backend

## FASE 2: ESTRUTURA BASE DO BACKEND

### 2.1 Configuraﾃｧﾃ｣o do TypeORM e Entidades 笨 CONCLUﾃ好O
- [x] Criar entidade Usuario (id, email, nome, senha, tipo, ativo, timestamps)
- [x] Criar entidade Turma (id, nome, serie, turno, ano, valorMensalidade, ativa, timestamps)  
- [x] Criar entidade Aluno (id, matricula, nome, dataNascimento, cpf, rg, endereco, telefone, email, ativo, timestamps)
- [x] Criar entidade ResponsavelFinanceiro (id, nome, cpfCnpj, email, telefone, endereco, cidade, estado, cep, inscricaoEstadual, inscricaoMunicipal, razaoSocial, ativo, timestamps)
- [x] Criar entidade Mensalidade (id, mes, ano, valor, dataVencimento, dataPagamento, status, observacoes, numeroNfse, dataEmissaoNfse, linkPdfNfse, nfseEmitida, timestamps)
- [x] Criar entidade FilaEmissao (id, status, provider, tentativas, maxTentativas, ultimoErro, dadosProvider, respostaProvider, dataProcessamento, proximaTentativa, timestamps)
- [x] Configurar relacionamentos entre entidades com Foreign Keys
- [x] Gerar e executar migraﾃｧﾃ｣o no banco PostgreSQL
- [x] Testar conexﾃ｣o e inicializaﾃｧﾃ｣o do servidor
  ```


### 2.2 Mﾃｳdulos e Serviﾃｧos Base 笨 CONCLUﾃ好O
- [x] Criar mﾃｳdulo de autenticaﾃｧﾃ｣o (AuthModule)
- [x] AuthController com endpoints de login, profile e validate-token
- [x] AuthService com validaﾃｧﾃ｣o de credenciais e geraﾃｧﾃ｣o JWT
- [x] JwtStrategy para validaﾃｧﾃ｣o de tokens
- [x] JwtAuthGuard para proteﾃｧﾃ｣o de rotas
- [x] RolesGuard para controle de permissﾃｵes (admin/operador)
- [x] Decorators @Roles e @GetUser para facilitar uso
- [x] DTOs para LoginDto e AuthResponseDto
- [x] Configuraﾃｧﾃ｣o de CORS e validaﾃｧﾃ｣o global
- [x] Testes funcionais da API de autenticaﾃｧﾃ｣o
- [x] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

- [x] Criar mﾃｳdulo de usuﾃ｡rios (UsuariosModule) 笨 CONCLUﾃ好O
- [x] UsuariosController (CRUD completo, apenas admin)
- [x] UsuariosService com validaﾃｧﾃｵes de negﾃｳcio
- [x] CreateUsuarioDto, UpdateUsuarioDto, UsuarioResponseDto
- [x] Proteﾃｧﾃ｣o por roles (apenas admins podem acessar)
- [x] Validaﾃｧﾃｵes de email ﾃｺnico e proteﾃｧﾃ｣o do ﾃｺltimo admin
- [x] Endpoint de ativar/desativar usuﾃ｡rio
- [x] Hash automﾃ｡tico de senhas com bcryptjs
- [x] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

- [x] Criar mﾃｳdulo de turmas (TurmasModule) 笨 CONCLUﾃ好O
  - TurmasController
  - TurmasService
  - CreateTurmaDto, UpdateTurmaDto
  - Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

- [x] Criar mﾃｳdulo de alunos (AlunosModule) 笨 CONCLUﾃ好O
  - AlunosController
  - AlunosService
  - CreateAlunoDto, UpdateAlunoDto, ImportAlunosDto
  - Funcionalidades de mensalidade personalizada
  - Endpoints para atualizar e consultar mensalidade
  - Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

- [ ] Criar mﾃｳdulo de responsﾃ｡veis (ResponsaveisModule)
  - ResponsaveisController
  - ResponsaveisService
  - CreateResponsavelDto, UpdateResponsavelDto
  - Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

## FASE 3: FUNCIONALIDADES CORE DO BACKEND

### 3.1 Sistema de Autenticaﾃｧﾃ｣o 笨 CONCLUﾃ好O
- [x] Implementar endpoint POST /auth/login
- [x] Implementar hash de senhas com bcryptjs
- [x] Implementar geraﾃｧﾃ｣o e validaﾃｧﾃ｣o de JWT
- [x] Criar decoradores para proteﾃｧﾃ｣o de rotas
- [x] Implementar middleware de autorizaﾃｧﾃ｣o por perfil

### 3.2 CRUD Bﾃ｡sico de Entidades
- [ ] Implementar CRUD completo de Usuﾃ｡rios (apenas admin)
- [ ] Implementar CRUD completo de Turmas
- [ ] Implementar CRUD completo de Alunos
- [ ] Implementar CRUD completo de Responsﾃ｡veis Financeiros
- [ ] Implementar relacionamentos entre entidades
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 3.3 Importaﾃｧﾃ｣o de Planilhas
- [ ] Criar endpoint POST /alunos/importar
- [ ] Implementar parsing de arquivo Excel/CSV
- [ ] Validar dados da planilha:
  - Campos obrigatﾃｳrios
  - Formato de CPF/CNPJ
  - Formato de email
  - Duplicatas
- [ ] Criar responsﾃ｡veis financeiros automaticamente se nﾃ｣o existirem
- [ ] Retornar relatﾃｳrio de importaﾃｧﾃ｣o (sucessos/erros)
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 3.4 Sistema de Mensalidades
- [ ] Criar endpoint GET /turmas/:id/mensalidades
- [ ] Implementar auto-criaﾃｧﾃ｣o de 12 mensalidades para cada aluno
- [ ] Criar endpoint PATCH /mensalidades/:id/marcar-pago
- [ ] Implementar lﾃｳgica para adicionar ﾃ fila de emissﾃ｣o automaticamente
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

## FASE 4: INTEGRAﾃﾃグ COM PROVEDORES DE NFSE (ARQUITETURA DESACOPLADA)

### 4.1 Interface e Abstraﾃｧﾃｵes Base
- [ ] Criar interface NFSeProvider:
  ```typescript
  interface NFSeProvider {
    criarContato(dados: ContatoDto): Promise<ContatoResponse>;
    obterContato(cpfCnpj: string): Promise<ContatoResponse | null>;
    emitirNFSe(dados: NFSeDto): Promise<NFSeResponse>;
    consultarStatus(numeroNfse: string): Promise<StatusResponse>;
    obterPDF(numeroNfse: string): Promise<Buffer>;
    cancelarNFSe(numeroNfse: string): Promise<CancelamentoResponse>;
  }
  ```

- [ ] Criar DTOs padronizados:
  ```typescript
  // ContatoDto, NFSeDto, NFSeResponse, etc.
  // Formato comum independente do provider
  ```

- [ ] Criar NFSeService principal:
  ```typescript
  // Serviﾃｧo que usa o provider ativo
  // Implementa retry, logs e fallback
  ```

### 4.2 Implementaﾃｧﾃ｣o do BlingProvider
- [ ] Criar BlingProvider implementando NFSeProvider
- [ ] Implementar autenticaﾃｧﾃ｣o com API Bling
- [ ] Mapear dados padronizados para formato Bling
- [ ] Implementar tratamento de erros especﾃｭficos do Bling
- [ ] Testes unitﾃ｡rios do BlingProvider
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 4.3 Preparaﾃｧﾃ｣o para PrefeituraProvider
- [ ] Criar PrefeituraProvider (implementaﾃｧﾃ｣o inicial/mock)
- [ ] Estrutura para diferentes APIs municipais
- [ ] Sistema de configuraﾃｧﾃ｣o por municﾃｭpio
- [ ] Documentaﾃｧﾃ｣o para implementaﾃｧﾃ｣o futura

### 4.4 Sistema de Configuraﾃｧﾃ｣o de Providers
- [ ] Configuraﾃｧﾃ｣o via environment (NFSE_PROVIDER=bling|prefeitura)
- [ ] Interface admin para trocar provider
- [ ] Validaﾃｧﾃ｣o de configuraﾃｧﾃｵes por provider
- [ ] Sistema de fallback entre providers

### 4.5 NFSeService Unificado
- [ ] Factory pattern para instanciar providers
- [ ] Logs unificados independente do provider
- [ ] Retry automﾃ｡tico com diferentes providers
- [ ] Cache de configuraﾃｧﾃｵes por provider
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 4.2 Processamento da Fila de Emissﾃ｣o
- [ ] Criar FilaEmissaoModule e FilaEmissaoService
- [ ] Implementar endpoint POST /fila-emissao/processar
- [ ] Lﾃｳgica de processamento:
  1. Buscar mensalidades na fila
  2. Para cada mensalidade:
     - Verificar/criar contato no Bling
     - Emitir NFSe via API Bling
     - Atualizar status da mensalidade
     - Remover da fila ou marcar erro
- [ ] Implementar retry para falhas temporﾃ｡rias
- [ ] Log detalhado de todas as operaﾃｧﾃｵes
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 4.3 Endpoints de NFSe
- [ ] Criar endpoint GET /nfse/:numeroNfse/pdf
- [ ] Implementar cache local de PDFs
- [ ] Criar endpoint para reprocessar notas com erro
- [ ] Implementar endpoint para cancelar NFSe
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

## FASE 5: FRONTEND - ESTRUTURA BASE

### 5.1 Configuraﾃｧﾃ｣o do Roteamento
- [ ] Configurar React Router
- [ ] Criar rotas protegidas
- [ ] Implementar redirecionamento baseado em autenticaﾃｧﾃ｣o
- [ ] Criar layout base da aplicaﾃｧﾃ｣o

### 5.2 Contexto de Autenticaﾃｧﾃ｣o
- [ ] Criar AuthContext
- [ ] Implementar hook useAuth
- [ ] Gerenciar token JWT no localStorage
- [ ] Implementar auto-logout em caso de token expirado

### 5.3 Serviﾃｧos de API
- [ ] Configurar Axios com interceptors
- [ ] Criar serviﾃｧos para cada mﾃｳdulo:
  - authService (login, logout, verificar token)
  - usuariosService
  - turmasService
  - alunosService
  - responsaveisService
  - mensalidadesService

### 5.4 Componentes Base
- [ ] Header/Navbar com menu de navegaﾃｧﾃ｣o
- [ ] Sidebar para navegaﾃｧﾃ｣o
- [ ] Componente de Loading
- [ ] Componente de Error
- [ ] Modal genﾃｩrico
- [ ] Componente de Confirmaﾃｧﾃ｣o

## FASE 6: FRONTEND - TELAS PRINCIPAIS

### 6.1 Tela de Login
- [ ] Formulﾃ｡rio de login (email/senha)
- [ ] Validaﾃｧﾃ｣o de campos
- [ ] Integraﾃｧﾃ｣o com AuthContext
- [ ] Tratamento de erros de autenticaﾃｧﾃ｣o
- [ ] Redirecionamento apﾃｳs login

### 6.2 Dashboard Principal
- [ ] Layout responsivo
- [ ] Cards com estatﾃｭsticas:
  - Total de alunos
  - Mensalidades pagas no mﾃｪs
  - Notas emitidas
  - Notas pendentes
- [ ] Grﾃ｡ficos simples (opcional)

### 6.3 Gestﾃ｣o de Usuﾃ｡rios (apenas admin)
- [ ] Listagem de usuﾃ｡rios com paginaﾃｧﾃ｣o
- [ ] Formulﾃ｡rio de criaﾃｧﾃ｣o de usuﾃ｡rio
- [ ] Formulﾃ｡rio de ediﾃｧﾃ｣o de usuﾃ｡rio
- [ ] Aﾃｧﾃ｣o de ativar/desativar usuﾃ｡rio
- [ ] Filtros e busca

### 6.4 Gestﾃ｣o de Turmas
- [ ] Listagem de turmas
- [ ] Formulﾃ｡rio de criaﾃｧﾃ｣o/ediﾃｧﾃ｣o de turma
- [ ] Aﾃｧﾃ｣o de ativar/desativar turma
- [ ] Visualizar quantidade de alunos por turma

### 6.5 Gestﾃ｣o de Alunos
- [ ] Listagem de alunos com filtro por turma
- [ ] Formulﾃ｡rio de cadastro manual de aluno
- [ ] Formulﾃ｡rio de ediﾃｧﾃ｣o de aluno
- [ ] Upload e processamento de planilha
- [ ] Visualizaﾃｧﾃ｣o de erros de importaﾃｧﾃ｣o

## FASE 7: FRONTEND - FUNCIONALIDADE PRINCIPAL

### 7.1 Interface de Mensalidades
- [ ] Seletor de turma
- [ ] Tabela dinﾃ｢mica:
  - Linhas: alunos da turma
  - Colunas: 12 meses do ano
  - Cﾃｩlulas: checkbox para marcar pagamento
- [ ] Estados visuais diferentes:
  - Nﾃ｣o pago (cinza)
  - Pago (verde)
  - Nota emitida (azul com nﾃｺmero clicﾃ｡vel)
  - Erro (vermelho)
- [ ] Aﾃｧﾃｵes em lote:
  - Marcar toda uma linha (aluno)
  - Marcar toda uma coluna (mﾃｪs)

### 7.2 Processamento de Notas
- [ ] Botﾃ｣o "Emitir Notas Pendentes"
- [ ] Modal de confirmaﾃｧﾃ｣o
- [ ] Barra de progresso durante processamento
- [ ] Relatﾃｳrio de resultados:
  - Notas emitidas com sucesso
  - Erros ocorridos
  - Tempo de processamento
- [ ] Botﾃ｣o para reprocessar erros

### 7.3 Visualizaﾃｧﾃ｣o de Notas
- [ ] Nﾃｺmeros de NFSe clicﾃ｡veis na tabela
- [ ] Modal para preview da nota
- [ ] Download direto do PDF
- [ ] Histﾃｳrico de notas emitidas

## FASE 8: FUNCIONALIDADES COMPLEMENTARES

### 8.1 Exportaﾃｧﾃ｣o de Dados
- [ ] Botﾃ｣o "Exportar Dados"
- [ ] Seleﾃｧﾃ｣o de filtros:
  - Turma especﾃｭfica ou todas
  - Perﾃｭodo (mﾃｪs/ano)
  - Status das mensalidades
- [ ] Geraﾃｧﾃ｣o de Excel com mﾃｺltiplas abas:
  - Dados gerais dos alunos
  - Mensalidades por perﾃｭodo
  - Notas fiscais emitidas
- [ ] Download automﾃ｡tico do arquivo
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 8.2 Configuraﾃｧﾃｵes do Sistema
- [ ] Tela de configuraﾃｧﾃｵes (apenas admin)
- [ ] Configuraﾃｧﾃ｣o da API Bling:
  - Token de acesso
  - URL da API
  - Teste de conexﾃ｣o
- [ ] Configuraﾃｧﾃｵes de mensalidades:
  - Valor padrﾃ｣o por turma
  - Descriﾃｧﾃ｣o padrﾃ｣o do serviﾃｧo
  - Cﾃｳdigos municipais
- [ ] Configuraﾃｧﾃｵes de impostos
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 8.3 Logs e Auditoria
- [ ] Tela de logs de operaﾃｧﾃｵes
- [ ] Filtros por:
  - Usuﾃ｡rio
  - Tipo de operaﾃｧﾃ｣o
  - Data/perﾃｭodo
  - Status (sucesso/erro)
- [ ] Detalhes de cada operaﾃｧﾃ｣o
- [ ] Exportaﾃｧﾃ｣o de logs
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

## FASE 9: TESTES E VALIDAﾃﾃ髭S

### 9.1 Testes Backend
- [ ] Testes unitﾃ｡rios dos serviﾃｧos principais
- [ ] Testes de integraﾃｧﾃ｣o com banco de dados
- [ ] Testes de endpoints da API
- [ ] Testes de integraﾃｧﾃ｣o com Bling API (mock)
- [ ] Testes de validaﾃｧﾃ｣o de dados
- [ ] Atualizar JSON de referﾃｪncia da API para testes (Postman collection)

### 9.2 Testes Frontend
- [ ] Testes de componentes crﾃｭticos
- [ ] Testes de fluxos principais:
  - Login/logout
  - Importaﾃｧﾃ｣o de planilha
  - Marcaﾃｧﾃ｣o de mensalidades
  - Emissﾃ｣o de notas
- [ ] Testes de responsividade

### 9.3 Testes de Integraﾃｧﾃ｣o E2E
- [ ] Fluxo completo de uso
- [ ] Teste de diferentes perfis de usuﾃ｡rio
- [ ] Teste de cenﾃ｡rios de erro
- [ ] Performance em lotes grandes

## FASE 10: MELHORIAS E DEPLOY

### 10.1 Otimizaﾃｧﾃｵes
- [ ] Implementar paginaﾃｧﾃ｣o em todas as listagens
- [ ] Cache de configuraﾃｧﾃｵes
- [ ] Otimizaﾃｧﾃ｣o de consultas no banco
- [ ] Compressﾃ｣o de assets no frontend
- [ ] Lazy loading de componentes

### 10.2 Configuraﾃｧﾃ｣o para Produﾃｧﾃ｣o
- [ ] Variﾃ｡veis de ambiente para produﾃｧﾃ｣o
- [ ] Build otimizado do frontend
- [ ] Configuraﾃｧﾃ｣o do banco em produﾃｧﾃ｣o
- [ ] SSL/HTTPS
- [ ] Backup automatizado

### 10.3 Documentaﾃｧﾃ｣o
- [ ] README detalhado do projeto
- [ ] Documentaﾃｧﾃ｣o da API (Swagger)
- [ ] Manual do usuﾃ｡rio
- [ ] Guia de instalaﾃｧﾃ｣o
- [ ] Guia de troubleshooting

## CHECKLIST FINAL

### Validaﾃｧﾃｵes Obrigatﾃｳrias Antes do Deploy:
- [ ] Todos os endpoints funcionando corretamente
- [ ] Autenticaﾃｧﾃ｣o e autorizaﾃｧﾃ｣o implementadas
- [ ] Integraﾃｧﾃ｣o com Bling API testada
- [ ] Interface responsiva em diferentes dispositivos
- [ ] Importaﾃｧﾃ｣o de planilhas funcionando
- [ ] Emissﾃ｣o de notas funcionando
- [ ] Download de PDFs funcionando
- [ ] Exportaﾃｧﾃ｣o de dados funcionando
- [ ] Tratamento de erros implementado
- [ ] Logs de auditoria funcionando
- [ ] Backup do banco configurado
- [ ] SSL/HTTPS configurado
- [ ] Performance testada com dados reais
- [ ] Documentaﾃｧﾃ｣o completa
- [ ] JSON de referﾃｪncia da API atualizado e validado

### Funcionalidades Essenciais (MVP):
1. 笨 Login com dois perfis (admin/operador)
2. 笨 Cadastro manual de alunos e responsﾃ｡veis
3. 笨 Importaﾃｧﾃ｣o via planilha
4. 笨 Organizaﾃｧﾃ｣o por turmas
5. 笨 Tabela de mensalidades (alunos x 12 meses)
6. 笨 Marcaﾃｧﾃ｣o de pagamentos
7. 笨 Fila automﾃ｡tica de emissﾃ｣o
8. 笨 Integraﾃｧﾃ｣o com Bling para NFSe
9. 笨 Download de PDFs das notas
10. 笨 Exportaﾃｧﾃ｣o de dados para planilha
11. 笨 JSON de referﾃｪncia da API para testes completo